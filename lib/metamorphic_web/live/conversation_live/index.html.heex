<.header>
  Conversations
  <:subtitle>
    <div id="tokens-available">
      <span
        :if={
          Decimal.to_integer(@tokens_available) >
            Decimal.to_integer(
              Decimal.round(
                Decimal.mult(Decimal.from_float(0.25), Decimal.to_integer(@ai_tokens))
              )
            )
        }
        class="inline-flex items-center rounded-md bg-emerald-100 px-2 py-1 text-xs font-medium text-emerald-700"
      >
        Tokens available: <%= number_to_string(@tokens_available) %>
      </span>
      <span
        :if={
          Decimal.to_integer(@tokens_available) <=
            Decimal.to_integer(
              Decimal.round(
                Decimal.mult(Decimal.from_float(0.25), Decimal.to_integer(@ai_tokens))
              )
            ) && Decimal.to_integer(@tokens_available) > 0
        }
        class="inline-flex items-center rounded-md bg-yellow-100 px-2 py-1 text-xs font-medium text-yellow-700"
      >
        Tokens available: <%= number_to_string(@tokens_available) %>
      </span>
      <span
        :if={Decimal.to_integer(@tokens_available) <= 0}
        class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-700"
      >
        Tokens available: <%= number_to_string(@tokens_available) %>
      </span>
    </div>
  </:subtitle>
  <:actions>
    <.link patch={~p"/ai/conversations/new"}>
      <.button>New Conversation</.button>
    </.link>
  </:actions>
</.header>

<.info_banner
  :if={Decimal.to_integer(@tokens_available) <= 0}
  navigate={~p"/billing/user/#{@current_user.id}"}
  nav_title="Billing"
>
  Upgrade your subscription plan to get more monthly tokens.
</.info_banner>
<!-- Tip -->
<div class="bg-brand-50 shadow sm:rounded-lg my-4">
  <div class="px-4 py-5 sm:p-6">
    <h3 class="text-base font-semibold leading-6 text-gray-900">Token usage</h3>
    <div class="mt-2 max-w-xl text-sm font-light text-gray-500">
      <p>
        The entire message chain of your conversation is submitted to the chatbot with each request. To conserve your token usage, consider keeping conversations short and creating multiple conversations for each new question you have.
      </p>
    </div>
    <div class="mt-3 text-sm leading-6"></div>
  </div>
</div>

<ul id="conversations" role="list" class="pt-4 text-sm divide-y divide-brand-100">
  <li
    :for={conversation <- @conversations}
    id={"row-#{conversation.id}"}
    class="relative flex justify-between group gap-x-4 py-5 px-2 transition focus-within:ring-2 focus-within:ring-brand-500 focus-within:ring-offset-2 focus-within:ring-offset-gray-100  hover:cursor-pointer hover:bg-brand-50 sm:hover:rounded-lg sm:hover:scale-105"
  >
    <div class="font-semibold text-zinc-900">
      <.link navigate={~p"/ai/conversations/#{conversation}"}>
        <span class="absolute inset-x-0 -top-px bottom-0"></span>
        <%= conversation.name %>
      </.link>
    </div>
    <div>
      <.link
        phx-click={
          JS.push("delete", value: %{id: conversation.id}) |> hide("#row-#{conversation.id}")
        }
        data-confirm="Are you sure you want to delete the conversation?"
      >
        <.icon name="hero-trash" class="text-red-900 w-4 h-4" />
      </.link>
    </div>
  </li>
</ul>

<.modal
  :if={@live_action in [:new]}
  id="conversation-modal"
  show
  on_cancel={JS.patch(~p"/ai/conversations")}
>
  <.live_component
    module={MetamorphicWeb.ConversationLive.FormComponent}
    id={@conversation.id || :new}
    title={@page_title}
    action={@live_action}
    current_user={@current_user}
    conversation={@conversation}
    patch={~p"/ai/conversations"}
  />
</.modal>
