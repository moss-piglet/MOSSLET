name: Desktop Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      platforms:
        description: "Platforms to build (comma-separated: macos,linux,windows)"
        default: "macos,linux,windows"
      release:
        description: "Create GitHub release"
        type: boolean
        default: false

env:
  MOSSLET_NATIVE: "true"
  MIX_ENV: prod

jobs:
  build-macos:
    runs-on: macos-14
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'macos')
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          brew install wxwidgets create-dmg libsodium
          echo "C_INCLUDE_PATH=$(brew --prefix libsodium)/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$(brew --prefix libsodium)/lib" >> $GITHUB_ENV

      - name: Create macOS icon (icns)
        run: |
          mkdir -p icon.iconset
          sips -z 16 16     priv/static/images/icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     priv/static/images/icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     priv/static/images/icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     priv/static/images/icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   priv/static/images/icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   priv/static/images/icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   priv/static/images/icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   priv/static/images/icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   priv/static/images/icon.png --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 priv/static/images/icon.png --out icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o priv/static/images/icon.icns
          rm -rf icon.iconset

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict

      - name: Install dependencies
        run: |
          mix deps.clean --all
          mix deps.get --only prod
          mix deps.compile
          mix assets.deploy

      - name: Build release
        run: mix release desktop --overwrite

      - name: Package macOS app
        run: ./scripts/build_desktop.sh macos

      - name: Code sign (if secrets available)
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "APPLE_CERTIFICATE not set, skipping code signing"
            exit 0
          fi
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain

          APP_PATH="_build/desktop/Mosslet.app"
          SIGN_IDENTITY="Developer ID Application"

          # Find and sign all binaries, dylibs, and frameworks inside the app
          find "$APP_PATH" -type f \( -name "*.dylib" -o -name "*.so" -o -perm +111 \) | while read -r file; do
            if file "$file" | grep -q "Mach-O"; then
              echo "Signing: $file"
              codesign --force --timestamp --options runtime \
                --sign "$SIGN_IDENTITY" "$file" || true
            fi
          done

          # Sign the main app bundle last
          codesign --force --timestamp --options runtime --deep \
            --sign "$SIGN_IDENTITY" "$APP_PATH"

          # Verify
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      - name: Notarize (if secrets available)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          if [ -z "$APPLE_ID" ]; then
            echo "APPLE_ID not set, skipping notarization"
            exit 0
          fi

          # Create a ZIP for notarization
          cd _build/desktop
          VERSION=$(grep '@version' ../../mix.exs | head -1 | sed 's/.*"\(.*\)".*/\1/')
          zip -r "Mosslet-${VERSION}-macos-notarize.zip" Mosslet.app

          SUBMIT_OUTPUT=$(xcrun notarytool submit "Mosslet-${VERSION}-macos-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait 2>&1) || true
          echo "$SUBMIT_OUTPUT"
          SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
          if echo "$SUBMIT_OUTPUT" | grep -q "status: Invalid"; then
            echo "Notarization failed. Fetching log..."
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_PASSWORD"
            exit 1
          fi

          cd ..
          xcrun stapler staple desktop/Mosslet.app
          rm desktop/Mosslet-*-notarize.zip

      - name: Create DMG after signing/notarization
        run: |
          cd _build/desktop
          VERSION=$(grep '@version' ../../mix.exs | head -1 | sed 's/.*"\(.*\)".*/\1/')
          rm -f "Mosslet-${VERSION}-macos.dmg"
          create-dmg \
            --volname "MOSSLET $VERSION" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Mosslet.app" 150 190 \
            --app-drop-link 450 185 \
            "Mosslet-${VERSION}-macos.dmg" \
            "Mosslet.app" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-macos
          path: _build/desktop/*.dmg

  build-linux:
    runs-on: ubuntu-24.04
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'linux')
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwxgtk3.2-dev libwxgtk-webview3.2-dev libsodium-dev libfuse2

      - name: Install appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict

      - name: Install dependencies
        run: |
          mix deps.clean --all
          mix deps.get --only prod
          mix deps.compile
          mix assets.deploy

      - name: Build release
        run: mix release desktop --overwrite

      - name: Package Linux app
        run: ./scripts/build_desktop.sh linux

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-linux
          path: _build/desktop/*.AppImage

  build-windows:
    runs-on: windows-2022
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'windows')
    env:
      MOSSLET_WINDOWS: "true"
      XLA_BUILD: "false"
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          path-type: inherit
          install: >-
            git
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-libsodium
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-libvips

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict

      - name: Add MSYS2 to PATH
        shell: pwsh
        run: |
          echo "C:\msys64\mingw64\bin" >> $env:GITHUB_PATH
          echo "C:\msys64\usr\bin" >> $env:GITHUB_PATH

      - name: Set build environment variables
        shell: pwsh
        run: |
          echo "CC=gcc" >> $env:GITHUB_ENV
          echo "MAKE=make" >> $env:GITHUB_ENV
          echo "CFLAGS=-IC:/msys64/mingw64/include" >> $env:GITHUB_ENV
          echo "LDFLAGS=-LC:/msys64/mingw64/lib -lsodium" >> $env:GITHUB_ENV
          echo "C_INCLUDE_PATH=C:/msys64/mingw64/include" >> $env:GITHUB_ENV
          echo "LIBRARY_PATH=C:/msys64/mingw64/lib" >> $env:GITHUB_ENV
          echo "VIX_COMPILATION_MODE=PLATFORM_PROVIDED_LIBVIPS" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=C:/msys64/mingw64/lib/pkgconfig" >> $env:GITHUB_ENV

      - name: Install dependencies and build release
        shell: msys2 {0}
        env:
          PATH: /mingw64/bin:/usr/bin:${{ env.PATH }}
        run: |
          export PATH="/mingw64/bin:$PATH"
          export CFLAGS="-IC:/msys64/mingw64/include"
          export LDFLAGS="-LC:/msys64/mingw64/lib -lsodium"
          export C_INCLUDE_PATH="C:/msys64/mingw64/include"
          export LIBRARY_PATH="C:/msys64/mingw64/lib"
          export VIX_COMPILATION_MODE="PLATFORM_PROVIDED_LIBVIPS"
          export PKG_CONFIG_PATH="C:/msys64/mingw64/lib/pkgconfig"
          export XLA_BUILD="false"

          echo "Verifying libvips installation..."
          pkg-config --libs --cflags vips
          ls -la /mingw64/bin/libvips*.dll || echo "No libvips DLLs found"

          mix local.hex --force
          mix local.rebar --force
          mix deps.clean --all
          mix deps.get --only prod

          chmod +x scripts/vix_windows_patch.sh
          ./scripts/vix_windows_patch.sh

          if [ -f deps/argon2_elixir/Makefile ]; then
            sed -i 's/\$(CC) \$(CFLAGS)/$(CC) -shared $(CFLAGS)/g' deps/argon2_elixir/Makefile
            echo "Patched argon2_elixir Makefile"
          fi

          if [ -f deps/enacl/c_src/pwhash.c ]; then
            sed -i 's/size_t r;/unsigned long r;/g' deps/enacl/c_src/pwhash.c
            echo "Patched enacl pwhash.c"
          fi

          if [ -f deps/enacl/rebar.config ]; then
            echo '{port_env, [{"CFLAGS", "$CFLAGS -fPIC -O3 -IC:/msys64/mingw64/include"}, {"LDFLAGS", "$LDFLAGS -LC:/msys64/mingw64/lib -lsodium"}]}.' > deps/enacl/rebar.config
            echo "Patched enacl rebar.config"
          fi

          mix deps.compile --except vix

          chmod +x scripts/vix_windows_patch.sh
          ./scripts/vix_windows_patch.sh

          echo "First pass: Build vix NIF (expect Elixir compile to fail)..."
          mix deps.compile vix 2>&1 || true

          echo "Copying ALL required DLLs to vix priv directory..."
          VIX_PRIV_DIR="_build/prod/lib/vix/priv"

          for dll in /mingw64/bin/*.dll; do
            cp "$dll" "$VIX_PRIV_DIR/" 2>/dev/null || true
          done
          echo "Total DLLs copied: $(ls "$VIX_PRIV_DIR/"*.dll 2>/dev/null | wc -l)"

          echo "Second pass: Compile vix Elixir code with DLLs in place..."
          export PATH="$(pwd)/$VIX_PRIV_DIR:$PATH"
          mix deps.compile vix --force

          export PATH="$(pwd)/$VIX_PRIV_DIR:$PATH"
          mix compile

          mix assets.deploy
          mix release desktop --overwrite

      - name: Package Windows app
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path _build/desktop/Mosslet
          Copy-Item -Recurse _build/prod/rel/desktop/* _build/desktop/Mosslet/

          # Copy required DLLs
          Copy-Item C:/msys64/mingw64/bin/libsodium*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libgcc*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libwinpthread*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libstdc++*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue

          # Copy libvips and its dependencies
          Copy-Item C:/msys64/mingw64/bin/libvips*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libglib*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libgobject*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libintl*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libiconv*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libexpat*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libffi*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libpcre*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/zlib*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libjpeg*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libpng*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libtiff*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libwebp*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libheif*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libgio*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libgmodule*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue

      - name: Code sign Windows (if secrets available)
        if: env.WINDOWS_CERTIFICATE != ''
        shell: pwsh
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          $certBytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          $certPath = Join-Path $env:RUNNER_TEMP "certificate.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

          # Sign all .exe and .dll files in the release
          Get-ChildItem -Path _build/desktop/Mosslet -Include *.exe,*.dll -Recurse | ForEach-Object {
            Write-Host "Signing: $($_.FullName)"
            & $signtool sign /f $certPath /p $env:WINDOWS_CERTIFICATE_PASSWORD /tr http://timestamp.digicert.com /td sha256 /fd sha256 $_.FullName
          }

          Remove-Item $certPath

      - name: Convert PNG to ICO for installer
        shell: pwsh
        run: |
          choco install imagemagick -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          magick convert priv/static/images/icon.png -define icon:auto-resize=256,128,64,48,32,16 priv/static/images/icon.ico

      - name: Create launcher batch file
        shell: pwsh
        run: |
          $batContent = @"
          @echo off
          cd /d "%~dp0"
          start "" bin\desktop.bat start
          "@
          $batContent | Out-File -FilePath "_build/desktop/Mosslet/Mosslet.bat" -Encoding ASCII

      - name: Create Windows installer with Inno Setup
        shell: pwsh
        run: |
          $version = (Select-String -Path mix.exs -Pattern '@version "(.+)"').Matches.Groups[1].Value

          $issContent = @"
          [Setup]
          AppName=MOSSLET
          AppVersion=$version
          AppPublisher=MOSSLET
          AppPublisherURL=https://mosslet.com
          DefaultDirName={autopf}\MOSSLET
          DefaultGroupName=MOSSLET
          OutputDir=_build\desktop
          OutputBaseFilename=Mosslet-$version-windows-setup
          Compression=lzma2
          SolidCompression=yes
          PrivilegesRequired=lowest
          SetupIconFile=priv\static\images\icon.ico
          UninstallDisplayIcon={app}\bin\erl.exe

          [Files]
          Source: "_build\desktop\Mosslet\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

          [Icons]
          Name: "{group}\MOSSLET"; Filename: "{app}\Mosslet.bat"
          Name: "{autodesktop}\MOSSLET"; Filename: "{app}\Mosslet.bat"

          [Run]
          Filename: "{app}\Mosslet.bat"; Description: "Launch MOSSLET"; Flags: nowait postinstall skipifsilent
          "@

          $issContent | Out-File -FilePath "mosslet.iss" -Encoding UTF8

          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" mosslet.iss

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-windows
          path: _build/desktop/*-setup.exe

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.release == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Upload to Tigris
        env:
          RELEASES_BUCKET: ${{ secrets.RELEASES_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_HOST: ${{ secrets.AWS_HOST }}
        run: |
          if [ -z "$RELEASES_BUCKET" ]; then
            echo "RELEASES_BUCKET secret not set, skipping Tigris upload"
            exit 0
          fi
          VERSION=${{ steps.version.outputs.version }}
          for file in artifacts/mosslet-*/*; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "Uploading $FILENAME to v$VERSION/..."
              curl -X PUT \
                -H "Content-Type: application/octet-stream" \
                --aws-sigv4 "aws:amz:$AWS_REGION:s3" \
                --user "$AWS_ACCESS_KEY_ID:$AWS_SECRET_ACCESS_KEY" \
                --upload-file "$file" \
                --fail \
                "https://$RELEASES_BUCKET.$AWS_HOST/v$VERSION/$FILENAME"
              echo "Uploaded $FILENAME"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/mosslet-macos/*
            artifacts/mosslet-linux/*
            artifacts/mosslet-windows/*
