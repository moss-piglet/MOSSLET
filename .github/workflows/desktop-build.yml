name: Desktop Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      platforms:
        description: "Platforms to build (comma-separated: macos,linux,windows)"
        default: "macos,linux,windows"
      release:
        description: "Create GitHub release"
        type: boolean
        default: false

env:
  MOSSLET_NATIVE: "true"
  MIX_ENV: prod

jobs:
  build-macos:
    runs-on: macos-14
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'macos')
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          brew install wxwidgets create-dmg libsodium
          echo "C_INCLUDE_PATH=$(brew --prefix libsodium)/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$(brew --prefix libsodium)/lib" >> $GITHUB_ENV

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict

      - name: Install dependencies
        run: |
          mix deps.clean --all
          mix deps.get --only prod
          mix deps.compile
          mix assets.deploy

      - name: Build release
        run: mix release desktop --overwrite

      - name: Package macOS app
        run: ./scripts/build_desktop.sh macos

      - name: Code sign (if secrets available)
        if: env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain

          APP_PATH="_build/desktop/Mosslet.app"
          SIGN_IDENTITY="Developer ID Application"

          # Find and sign all binaries, dylibs, and frameworks inside the app
          find "$APP_PATH" -type f \( -name "*.dylib" -o -name "*.so" -o -perm +111 \) | while read -r file; do
            if file "$file" | grep -q "Mach-O"; then
              echo "Signing: $file"
              codesign --force --timestamp --options runtime \
                --sign "$SIGN_IDENTITY" "$file" || true
            fi
          done

          # Sign the main app bundle last
          codesign --force --timestamp --options runtime --deep \
            --sign "$SIGN_IDENTITY" "$APP_PATH"

          # Verify
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

          # Re-create ZIP with signed app
          cd _build/desktop
          rm -f Mosslet-*-macos.zip
          zip -r "Mosslet-$(grep '@version' ../../mix.exs | head -1 | sed 's/.*\"\(.*\)\".*/\1/')-macos.zip" Mosslet.app

      - name: Notarize (if secrets available)
        if: env.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          SUBMIT_OUTPUT=$(xcrun notarytool submit _build/desktop/Mosslet-*-macos.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait 2>&1) || true
          echo "$SUBMIT_OUTPUT"
          SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
          if echo "$SUBMIT_OUTPUT" | grep -q "status: Invalid"; then
            echo "Notarization failed. Fetching log..."
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_PASSWORD"
            exit 1
          fi
          xcrun stapler staple _build/desktop/Mosslet.app

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-macos
          path: |
            _build/desktop/*.dmg
            _build/desktop/*.zip

  build-linux:
    runs-on: ubuntu-24.04
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'linux')
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwxgtk3.2-dev libwxgtk-webview3.2-dev libsodium-dev libfuse2

      - name: Install appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict

      - name: Install dependencies
        run: |
          mix deps.clean --all
          mix deps.get --only prod
          mix deps.compile
          mix assets.deploy

      - name: Build release
        run: mix release desktop --overwrite

      - name: Package Linux app
        run: ./scripts/build_desktop.sh linux

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-linux
          path: |
            _build/desktop/*.AppImage
            _build/desktop/*.tar.gz

  build-windows:
    runs-on: windows-2022
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'windows')
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          path-type: inherit
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-libsodium

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict

      - name: Add MSYS2 to PATH
        shell: pwsh
        run: |
          echo "C:\msys64\mingw64\bin" >> $env:GITHUB_PATH
          echo "C:\msys64\usr\bin" >> $env:GITHUB_PATH

      - name: Setup mix
        shell: cmd
        run: |
          mix local.hex --force
          mix local.rebar --force

      - name: Get dependencies
        shell: cmd
        run: |
          mix deps.clean --all
          mix deps.get --only prod

      - name: Patch dependencies for Windows
        shell: pwsh
        run: |
          (Get-Content deps/argon2_elixir/Makefile) -replace '\$\(CC\) \$\(CFLAGS\)', '$(CC) -shared $(CFLAGS)' | Set-Content deps/argon2_elixir/Makefile
          (Get-Content deps/enacl/c_src/pwhash.c) -replace 'size_t r;', 'unsigned long r;' | Set-Content deps/enacl/c_src/pwhash.c
          $portEnv = "`n{port_env, [`n  {`"CFLAGS`", `"`$CFLAGS -I/c/msys64/mingw64/include -IC:/msys64/mingw64/include`"}`n  {`"LDFLAGS`", `"`$LDFLAGS -L/c/msys64/mingw64/lib -LC:/msys64/mingw64/lib -lsodium`"}`n]}.`n"
          Add-Content -Path deps/enacl/rebar.config -Value $portEnv

      - name: Compile and build release
        shell: cmd
        run: |
          set CC=gcc
          set MAKE=make
          set "CFLAGS=-IC:/msys64/mingw64/include"
          set "LDFLAGS=-LC:/msys64/mingw64/lib -lsodium"
          set "C_INCLUDE_PATH=C:/msys64/mingw64/include"
          set "LIBRARY_PATH=C:/msys64/mingw64/lib"

          mix deps.compile
          mix assets.deploy
          mix release desktop --overwrite

      - name: Package Windows app
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path _build/desktop/Mosslet
          Copy-Item -Recurse _build/prod/rel/desktop/* _build/desktop/Mosslet/

          # Copy required DLLs
          Copy-Item C:/msys64/mingw64/bin/libsodium*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libgcc*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libwinpthread*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue
          Copy-Item C:/msys64/mingw64/bin/libstdc++*.dll _build/desktop/Mosslet/bin/ -ErrorAction SilentlyContinue

      - name: Code sign Windows (if secrets available)
        if: env.WINDOWS_CERTIFICATE != ''
        shell: pwsh
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          $certBytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          $certPath = Join-Path $env:RUNNER_TEMP "certificate.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

          # Sign all .exe and .dll files in the release
          Get-ChildItem -Path _build/desktop/Mosslet -Include *.exe,*.dll -Recurse | ForEach-Object {
            Write-Host "Signing: $($_.FullName)"
            & $signtool sign /f $certPath /p $env:WINDOWS_CERTIFICATE_PASSWORD /tr http://timestamp.digicert.com /td sha256 /fd sha256 $_.FullName
          }

          Remove-Item $certPath

      - name: Create Windows ZIP
        shell: pwsh
        run: |
          $version = (Select-String -Path mix.exs -Pattern '@version "(.+)"').Matches.Groups[1].Value
          Compress-Archive -Path _build/desktop/Mosslet -DestinationPath "_build/desktop/Mosslet-$version-windows.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-windows
          path: _build/desktop/*.zip

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.release == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Upload to Tigris
        if: env.RELEASES_BUCKET != ''
        env:
          RELEASES_BUCKET: ${{ secrets.RELEASES_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_HOST: ${{ secrets.AWS_HOST }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for file in artifacts/mosslet-*/*; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "Uploading $FILENAME..."
              curl -X PUT \
                -H "Content-Type: application/octet-stream" \
                --aws-sigv4 "aws:amz:$AWS_REGION:s3" \
                --user "$AWS_ACCESS_KEY_ID:$AWS_SECRET_ACCESS_KEY" \
                --upload-file "$file" \
                "https://$RELEASES_BUCKET.$AWS_HOST/v$VERSION/$FILENAME"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/mosslet-macos/*
            artifacts/mosslet-linux/*
            artifacts/mosslet-windows/*
