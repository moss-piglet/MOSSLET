name: Desktop Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated: macos,linux,windows)'
        default: 'macos,linux,windows'
      release:
        description: 'Create GitHub release'
        type: boolean
        default: false

env:
  MOSSLET_NATIVE: 'true'
  MIX_ENV: prod

jobs:
  build-macos:
    runs-on: macos-14
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'macos')
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          brew install wxwidgets create-dmg libsodium
          echo "C_INCLUDE_PATH=$(brew --prefix libsodium)/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$(brew --prefix libsodium)/lib" >> $GITHUB_ENV

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28'
          elixir-version: '1.19'

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: deps
          key: ${{ runner.os }}-deps-v2-${{ hashFiles('**/mix.lock') }}

      - name: Install Elixir dependencies
        run: |
          mix deps.get --only prod
          mix deps.compile --skip-umbrella-children ex_cldr --force
          mix deps.compile
          mix assets.deploy

      - name: Build release
        run: mix release desktop --overwrite

      - name: Package macOS app
        run: ./scripts/build_desktop.sh macos

      - name: Code sign (if secrets available)
        if: env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          codesign --deep --force --verify --verbose \
            --sign "Developer ID Application" \
            _build/desktop/Mosslet.app

      - name: Notarize (if secrets available)
        if: env.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          xcrun notarytool submit _build/desktop/Mosslet-*-macos.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
          xcrun stapler staple _build/desktop/Mosslet.app

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-macos
          path: |
            _build/desktop/*.dmg
            _build/desktop/*.zip

  build-linux:
    runs-on: ubuntu-24.04
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'linux')
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwxgtk3.2-dev libwxgtk-webview3.2-dev libsodium-dev

      - name: Install appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28'
          elixir-version: '1.19'

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: deps
          key: ${{ runner.os }}-deps-v2-${{ hashFiles('**/mix.lock') }}

      - name: Install Elixir dependencies
        run: |
          mix deps.get --only prod
          mix deps.compile --skip-umbrella-children ex_cldr --force
          mix deps.compile
          mix assets.deploy

      - name: Build release
        run: mix release desktop --overwrite

      - name: Package Linux app
        run: ./scripts/build_desktop.sh linux

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-linux
          path: |
            _build/desktop/*.AppImage
            _build/desktop/*.tar.gz

  build-windows:
    runs-on: windows-2022
    if: contains(github.event.inputs.platforms || 'macos,linux,windows', 'windows')
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-libsodium

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28'
          elixir-version: '1.19'

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: deps
          key: ${{ runner.os }}-deps-v2-${{ hashFiles('**/mix.lock') }}

      - name: Install Elixir dependencies
        shell: msys2 {0}
        run: |
          mix deps.get --only prod
          mix deps.compile --skip-umbrella-children ex_cldr --force
          mix deps.compile
          mix assets.deploy

      - name: Build release
        shell: msys2 {0}
        run: mix release desktop --overwrite

      - name: Package Windows app
        shell: bash
        run: |
          mkdir -p _build/desktop/Mosslet
          cp -R _build/prod/rel/desktop/* _build/desktop/Mosslet/
          cd _build/desktop
          7z a -tzip Mosslet-windows.zip Mosslet

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mosslet-windows
          path: _build/desktop/*.zip

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.release == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Upload to Tigris
        if: env.RELEASES_BUCKET != ''
        env:
          RELEASES_BUCKET: ${{ secrets.RELEASES_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_HOST: ${{ secrets.AWS_HOST }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for file in artifacts/mosslet-*/*; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "Uploading $FILENAME..."
              curl -X PUT \
                -H "Content-Type: application/octet-stream" \
                --aws-sigv4 "aws:amz:$AWS_REGION:s3" \
                --user "$AWS_ACCESS_KEY_ID:$AWS_SECRET_ACCESS_KEY" \
                --upload-file "$file" \
                "https://$RELEASES_BUCKET.$AWS_HOST/v$VERSION/$FILENAME"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/mosslet-macos/*
            artifacts/mosslet-linux/*
            artifacts/mosslet-windows/*
